<source>
  @type systemd
  @id systemd-input
  @label @OUTPUT
  path "#{ENV['JOURNAL_SOURCE'] || '/run/log/journal'}"
  <storage>
    @type local
    persistent true
    # NOTE: if this does not end in .json, fluentd will think it
    # is the name of a directory - see fluentd storage_local.rb
    path "#{ENV['JOURNAL_POS_FILE'] || '/var/log/journal_pos.json'}"
  </storage>
  matches "#{ENV['JOURNAL_FILTERS_JSON'] || '[]'}"
  tag journal
  read_from_head "#{ENV['JOURNAL_READ_FROM_HEAD'] || 'false'}"
</source>
<source>
  @type tail
  @id container-input
  path "/var/log/containers/*.log"
  pos_file "/var/log/es-containers.log.pos"
  tag kubernetes.*
  read_from_head "true"
  exclude_path []
  @label @CONCAT
  <parse>
    @type multi_format
    <pattern>
      format json
      time_format \'%Y-%m-%dT%H:%M:%S.%N%Z\'
      keep_time_key true
    </pattern>
    <pattern>
      format regexp
      expression /^(?<time>.+) (?<stream>stdout|stderr)( (?<logtag>.))? (?<log>.*)$/
      time_format \'%Y-%m-%dT%H:%M:%S.%N%:z\'
      keep_time_key true
    </pattern>
  </parse>
</source>
<label @CONCAT>
  <filter kubernetes.**>
    @type concat
    key log
    partial_key logtag
    partial_value P
    separator \'\'
  </filter>
  <match kubernetes.**>
    @type relabel
    @label @OUTPUT
  </match>
</label>
<label @OUTPUT>
  <match **>
    @type loki
    url "http://#{ENV['LOKI_SERVICE_HOST']}:#{ENV['LOKI_SERVICE_PORT'}}"
    <buffer>
      @type file
      path '/var/lib/fluentd/loki'
      flush_interval "#{ENV['ES_FLUSH_INTERVAL'] || '1s'}"
      flush_thread_count "#{ENV['ES_FLUSH_THREAD_COUNT'] || 1}"
      flush_at_shutdown "#{ENV['FLUSH_AT_SHUTDOWN'] || 'false'}"
      retry_max_interval "#{ENV['ES_RETRY_WAIT'] || '300'}"
      retry_forever true
      queued_chunks_limit_size "#{ENV['BUFFER_QUEUE_LIMIT'] || '32' }"
      chunk_limit_size "#{ENV['BUFFER_SIZE_LIMIT'] || '8m' }"
      overflow_action "#{ENV['BUFFER_QUEUE_FULL_ACTION'] || 'block'}"
    </buffer>
  </match>
</label>
